name: Release (Docker)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-wasm:
    name: Build plugin.wasm
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      sha: ${{ steps.meta.outputs.sha }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          submodules: true

      - name: Record tag + commit sha
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "sha=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Install Rust 1.93 toolchain + wasm target
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.93"
          components: rustc rust-std cargo clippy rustfmt
          targets: wasm32-wasip1

      - name: Show active toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustc -Vv
          cargo -V
          rustup target list --installed

      - name: Install cargo-auditable
        shell: bash
        run: cargo install cargo-auditable

      - name: Build wasm (auditable)
        shell: bash
        run: |
          set -euo pipefail
          cargo fetch
          cargo auditable build --release --target wasm32-wasip1
          cp target/wasm32-wasip1/release/plugin.wasm ./plugin.wasm

      - name: Ensure plugin.wasm exists
        shell: bash
        run: |
          set -euo pipefail
          ls -lh ./plugin.wasm

      - name: Upload wasm artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-wasm
          path: plugin.wasm
          if-no-files-found: error

  package-and-push:
    name: Package + push image + sign
    needs: build-wasm
    environment: production
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
      id-token: write # keyless signing
    outputs:
      tag_ref: ${{ steps.meta.outputs.tag_ref }}
      latest_ref: ${{ steps.meta.outputs.latest_ref }}
      tag_digest: ${{ steps.digest.outputs.tag_digest }}
      latest_digest: ${{ steps.digest.outputs.latest_digest }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Download wasm artifact
        uses: actions/download-artifact@v4
        with:
          name: plugin-wasm
          path: .

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image refs
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="ghcr.io/${{ github.repository }}"
          TAG="${{ needs.build-wasm.outputs.tag }}"
          echo "tag_ref=${IMAGE}:${TAG}" >> "$GITHUB_OUTPUT"
          echo "latest_ref=${IMAGE}:latest" >> "$GITHUB_OUTPUT"

      - name: Build and push image (linux/amd64; copies plugin.wasm)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          provenance: false
          tags: |
            ${{ steps.meta.outputs.tag_ref }}
            ${{ steps.meta.outputs.latest_ref }}

      - name: Resolve digests
        id: digest
        shell: bash
        run: |
          set -euo pipefail

          tag_ref="${{ steps.meta.outputs.tag_ref }}"
          latest_ref="${{ steps.meta.outputs.latest_ref }}"

          tag_digest="$(
            docker buildx imagetools inspect "$tag_ref" --format '{{json .Manifest}}' \
              | python3 -c 'import json,sys; print(json.load(sys.stdin)["digest"])'
          )"

          latest_digest="$(
            docker buildx imagetools inspect "$latest_ref" --format '{{json .Manifest}}' \
              | python3 -c 'import json,sys; print(json.load(sys.stdin)["digest"])'
          )"

          if [[ ! "$tag_digest" =~ ^sha256:[0-9a-f]{64}$ ]]; then
            echo "ERROR: Invalid tag digest: '$tag_digest'" >&2
            exit 1
          fi
          if [[ ! "$latest_digest" =~ ^sha256:[0-9a-f]{64}$ ]]; then
            echo "ERROR: Invalid latest digest: '$latest_digest'" >&2
            exit 1
          fi

          echo "tag_digest=$tag_digest" >> "$GITHUB_OUTPUT"
          echo "latest_digest=$latest_digest" >> "$GITHUB_OUTPUT"

          echo "Resolved tag digest:    $tag_digest"
          echo "Resolved latest digest: $latest_digest"

      - name: Sign by digest (tag + latest)
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="ghcr.io/${{ github.repository }}"
          cosign sign --yes "${IMAGE}@${{ steps.digest.outputs.tag_digest }}"
          cosign sign --yes "${IMAGE}@${{ steps.digest.outputs.latest_digest }}"

  publish-release:
    name: Publish GitHub Release
    needs: package-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download plugin.wasm artifact
        uses: actions/download-artifact@v4
        with:
          name: plugin-wasm
          path: .

      - name: Create release notes
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          IMAGE="ghcr.io/${{ github.repository }}"
          TAG_DIGEST="${{ needs.package-and-push.outputs.tag_digest }}"

          cat > release-body.md <<EOF
          Release for \`${TAG}\`.

          Container image (tag):
          - \`${IMAGE}:${TAG}\`

          âœ… Immutable digest (recommended for pinning):
          - \`${IMAGE}@${TAG_DIGEST}\`

          Release asset:
          - \`plugin.wasm\`

          All container images are signed with Cosign. Verify the **immutable digest** with:

          \`\`\`bash
          cosign verify \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/.github/workflows/release.yml@refs/tags/${TAG}" \
            --certificate-oidc-issuer-regexp "https://token.actions.githubusercontent.com" \
            ${IMAGE}@${TAG_DIGEST}
          \`\`\`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          preserve_order: true
          body_path: release-body.md
          files: |
            plugin.wasm
